# 한국 아파트 단위평면 데이터셋 {#sec:floorplan}

## 목적

이 장에서는 한국 아파트 단위평면의 공간배치를 데이터셋으로 구축한다.
데이터셋 (dataset, 정보집합물)은 "구조화된 데이터 개체들의 식별 가능한 집합"을 말한다. [@ProjectOpenData2014]
개별 자료가 체계적으로 정리되어 그 전체가 하나로서 인식되는 모든 자료의 집합은 데이터셋이 될 수 있으나,
현재는 그중에서도 특히 전자적으로 저장 및 공유되어 컴퓨터를 이용한 분석에 활용될 수 있는 것을 지칭한다.

[@sec:dl]에서 살펴본 바와 같이,
한국 아파트 연구에 딥 러닝 분석을 적용하기 위해서는
한국 아파트 전체를 대표할 수 있는 데이터가 필수적이다.
공개된 정보를 활용하여 전국 아파트의 단위평면 및 관련 자료를 수집하고,
평면에서 나타나는 공간배치를 인식하는 알고리즘을 개발하고 적용한다.
인식된 공간배치와 관련 정보를 딥 러닝 모형에 입력할 수 있는 형식으로 정리하여 데이터셋으로 구축한다.

이러한 과정을 개별 평면에 대한 수작업 없이도 처리할 수 있도록 하여,
누구라도 같은 과정을 통해 연구의 결과를 재현할 수 있도록 한다.
이렇게 구축된 단위평면 데이터셋을 활용하여
한국 아파트의 진화과정에 대한 분석을 전수조사를 통해 수행할 수 있도록 한다.

## 단위평면 수집

한국에 아파트가 도입된 이후 현재까지 준공된 아파트의
단위세대 유형을 대상으로 평면도 데이터셋을 구축한다.
선행연구에서는 대체로 서울의 대규모 단지를 중심으로 분석 대상을 한정하였다.
그 이유는
원본 데이터 자체가 일부 지역이나 시기, 유형에 한정되어 있거나
수작업을 통한 분석의 한계로 인해
연구 범위를 인위적으로 제한할 필요가 있기 때문이다.
본 연구에서는
데이터를 수집하고 분석하는 전 과정을 자동화하여 이러한 한계를 극복하고
지방 및 소규모 단지 등 기존 연구에서 놓친 사례를
모두 분석 대상에 포괄하는 것을 목표로 한다.
이를 위해
전국 아파트에 대한 정보를 공개적으로 제공하는 네이버 부동산에서
단위세대 평면도 및 관련 계획 정보를 수집하고,
그 데이터를 기계학습에 적용할 수 있는 형태로 처리한 데이터셋을 구축한다.

네이버 부동산에서는 2017년 5월 24일 기준
전국 아파트 29,663 단지의 121,258 평면유형에 대한 정보를 제공하며,
51,497개 유형에 대한 평면도가 게시되어 있었다. [@naverland]
그 중에서
평면도 이미지 파일 자체에 오류가 있거나,
한 평면도 안에 타 평면유형을 포함한 경우,
복층 등을 제외한
50,540개 단위세대 유형을 분석 대상으로 한다.

![시도별 연도별 평면도 수록 건수 [@naverland]](floorplans_by_year_sido.png)

## 공간배치 인식

아파트 평면도에서 나타나는 다양한 오류에 견고한(robust) 공간배치 인식 알고리즘을 개발한다.

네이버 부동산에서 제공하는 아파트 평면도는 이미지 형식으로,
단위세대를 중심으로 실내 공간배치를 표현하고 있다.
주거의 성격을 결정하는 데 가장 중요한 각 실의 성격과 배치는 색으로 구분되고
굵은 선으로 표현된 벽으로 경계지어져 분명하게 표현된다.
그 외에 각 실의 이름, 가구 배치, 면적, 치수 등의 정보가 부가되지만,
이러한 정보는 도면에 따라 일관되지 않게 달라지며,
현관이나, 드레스룸, 발코니, 다용도실 등 규모가 작은 부속실의 경우
도면에 따라 실 이름이 제공되지 않기도 한다.
또한 가구는 다양한 형식으로 표현될 뿐만 아니라 축척이 틀리는 경우도 있고,
실별 면적 및 치수는 도면에 따라 제공되지 않는 경우가 많다.
단위세대에 인접한 코어 및 인접세대가
세대 내부와 유사한 형식으로 표현되어 구분을 어렵게 하기도 한다.
따라서 모든 평면도에서 공간배치를 인식할 수 있는 알고리즘을 개발하기 위해서는
이러한 차이점을 고려할 필요가 있다.

![평면도 예시 [@naverland]](floorplan_samples.png){#fig:samples}

평면도에 존재하는 오류는 도면들 간의 차이보다 더 근본적인 문제이다.
사람은 도면에 다양한 오류가 있어도 어려움 없이 실제 내용을 파악할 수 있지만
컴퓨터는 주어진 입력을 있는 그대로 인식하기 때문에 현실과 동떨어진 결과를 내놓는다.
예를 들어, 네이버 부동산에서 제공하는 평면도는
세대 경계를 모두 벽체로 표현하면서 발코니의 창호 혹은 난간을 무시하는 경우가 대부분이다.
이를 주어진 정보대로 인식한다면 그 세대는 창이 없는 \`먹방'으로 보일 것이다.
또한, 모든 도면은 사람이 작성한 이상 실수가 발생한다.
특히 공간 사이의 경계가 벽체로 그려지거나 문이 그려지지 않는 등의 오류는
공간의 연결구조를 평면도에서 인식하려는 시도를 원천적으로 차단한다.

이러한 오류가 모든 도면에 일관되게 유지된다면
알고리즘에 그러한 특성을 반영하여 교정할 수도 있다.
그러나 발코니 창호 표현처럼 의도적인 경우에도 통일되어 있지 않으며
각 도면에는 의도적인 표현과 실수를 아울러 다양한 오류가 발생한다.
현실적으로 모든 도면이 오류 없이 그려져있다고 가정할 수 없기 때문에,
평면도에서 공간배치를 인식하려는 알고리즘도 이러한 한계를 반영한다.

이렇게 컴퓨터가 도면을 인식하려고 할 때는 치명적인 오류가
도면을 작성하고, 검수하고, 공개 후에는 오류를 신고받아 수정하는
여러 절차를 거친 이후에도 남아있다는 것은
그러한 오류에도 불구하고 많은 사람이 평면도를 읽는 데 큰 지장이 없었다는 뜻이다.
발코니 창호가 벽체로 그려져 있더라도,
사람은 발코니가 무엇인지, 아파트가 대체로 어떻게 생겼는지를 선험적으로 알고 있으므로
깨닫지도 못하는 사이에 주어지지 않은 정보를 이용해 도면을 고쳐 인식한다.
마찬가지로, 문 없이 벽으로 막힌 방이 평면도에 존재해도
사람은 작성자의 의도를 이해하고, 심지어 문이 있을 위치를 추측할 수도 있다.
이는 사람이 평면도를 읽고 공간배치를 인식하는 방식이
도면 정보를 있는 그대로 받아들이는 것과는 다르다는 의미이다.

반대로, 사람들이 가장 먼저 인식하고 고칠 필요를 느끼는 오류는
검증 과정에서 제일 쉽게 걸러질 것이므로,
모든 평면도에서 가장 일관되게 오류 없이 표현되는 정보야말로
사람이 평면도를 인식하기 위해 가장 핵심적으로 의존하는 정보가 된다.
컴퓨터가 사람과 같은 방식으로 공간을 인식하도록 하려면
사람이 공간배치를 인식하고 재구성할 수 있도록 하는 최소한의 정보만을 제공하고
그 안에서 공간배치를 읽어내는 법을 학습시켜야 한다.
네이버 부동산의 평면도에서 이러한 정보에 해당하는 것은
모든 도면에서 가장 명확하고 오류 없이 제공되는
색으로 표현된 공간 구분이다.
평면도는 단위세대 내부를 외부와 다른 색으로 채워 나타내고 있으며,
특히 현관, LDK (거실 및 주방, 식당), 침실, 발코니, 화장실은
각 실만의 색으로 일관되게 표현되고 있다.

따라서 본 연구에서는 이러한 평면도의 특성을 반영한 공간배치 인식 알고리즘을 개발한다.
먼저 색으로 표현된 공간 정보를 이용해 단위세대 영역을 인식한 후,
그 다음 각 공간에 대한 정보를 독립된 계층으로 분리하는
두 단계의 과정을 통해 평면도에 표현된 공간배치를 인식한다.
이 과정에서 이미지 파일 형식으로 제공되는 평면도를 분석하기 위하여
영상처리 라이브러리인 OpenCV를 활용한다. [@opencv_library]
이렇게 인식된 각 평면유형별 공간배치 정보는
다음 단계에서 딥 러닝 분석에 적용할 수 있는 데이터셋으로 구축하는 것을 목표로 한다.

### 단위세대 영역

평면도에서 각 실을 구분짓는 가장 중요한 정보는 벽과 개구부이지만
모든 평면도에서 개구부가 정확하게 표현되어 있는 것은 아니다.
도면 작성 과정에서 문을 빠뜨리면 벽으로 둘러싸인 어느 곳에도 연결되지 않은 방이 그려진다.
물론 현실에 존재하는 아파트에는 그런 일이 일어날 수 없고, 그 방은 어딘가로 연결되겠지만,
평면도에는 그러한 정보가 제공되지 않는다.
이렇게 각 실의 연결관계가 정확하게 표현되지 않은 상황에서
불명확한 정보를 바탕으로 공간의 구조를 파악하고 실내외를 경계짓는 것은 불가능하다.

그러나 사람은 이러한 도면에서도 공간을 재구성하는데 어려움을 겪지 않는다.
일반적인 아파트가 어떻게 생겼는지를 알고 있기 때문에,
실의 경계에 대한 정보가 없거나 부정확하더라도 무의식 중에 재구성하여 인식할 수 있다.
역설적이지만 이러한 문제가 사람에게는 이해에 방해되지 않는 사소한 문제이기 때문에
실수가 발견되지 않고 수정되지 않은 채 남아있었던 것이다.

모든 평면도에서 가장 정확하게 그려진 정보는 색으로 구분된 각 실의 기능이다.
사람도 이러한 정보에 가장 크게 의존하기 때문에, 이를 중심으로 단위세대를 인식할 필요가 있다.
색으로 구분되어 표현된 실들의 집합으로 단위세대 영역을 정의하고
실내에만 사용된 색, 실내외 공간에 모두 사용된 색을 찾고
단위세대 내부를 인식할 수 있는 절차적인 방법을 정의한다.

<div id="fig:">

![평면도 원본 [@naverland]](floorplan.jpg){width=45%}
![방 및 경계 인식](floorplan_rooms.pdf){width=45%}

![실내 영역 인식](floorplan_indoor.pdf){width=45%}

아파트 평면도 실내 영역 인식
</div>

### 주거공간 정의

각자 다른 색으로 표현된 각 공간을 독립된 계층으로 분리하여 정리한다.

LDK를 별도로 분리할 수 없는 이유는
한국 아파트에서는 거실과 주방 및 식당 사이의 경계가 모호하고
평면도에서도 각 공간에 대한 표기와 구분에 일관성이 없기 때문이다.

단위세대 영역에 더하여, 
LDK (거실 및 주방, 식당), 침실, 현관, 발코니, 화장실을
별도의 계층으로 정리한다.

<div id="fig:">

![평면도 원본 [@naverland]](floorplan.jpg){height=25%} \qquad
![주거공간 인식](floorplan_processed.pdf){height=25%}

아파트 평면도 공간배치 인식
</div>

## 단위평면 데이터셋 구축

공간배치 인식 알고리즘을 아파트 평면도에 적용한 결과를
기계학습에 적합한 형태로 변환하여 정리한
공간배치 데이터셋을 구축한다.

평면유형의 공간배치는 $28 \times 28 \times 6 = 4\,704$차원의 공간으로 표현된다.

공간배치와 함께 해당 유형에 대한 관련 정보를 함께 정리한다.

지역이나 시기, 면적 등의 정보는
기계학습 알고리즘이 각 특성별로 달라지는 공간배치를 잘 학습할 수 있도록
적절한 정규화 과정을 거친다.

범주형 변수의 경우,
기계학습으로 각 범주의 특성을 학습하기 위해서는
모든 범주에 비슷한 규모의 충분한 사례가 필요하다.
그러나 아파트는 수도권에 집중되어 있어
그 수준에 정확하게 맞춘다면 서울과 경기, 기타 지방의 3등분이 되어,
지역별 특색에 따른 차이가 사라지게 된다.
지역과 사례 수가 균형적인 수준에서 지역별 권역을 설정하여
평면유형 분포의 불균형을 완화하면서 지역별 차이를 학습할 수 있도록 하였다.

|권역코드|해당 지역|평면유형 수|
|:---:|-------------------------------|---------:|
|0|서울|15,125|
|1|경기|14,444|
|2|인천|3,288|
|3|강원|1,107|
|4|대전, 세종, 충남, 충북|4,226|
|5|부산, 울산, 경남|6,866|
|6|대구, 경북|3,242|
|7|광주, 전남, 전북|2,075|
|8|제주|167|

: 시도별 권역 정의 {#tbl:sido}

연속형 변수를 심층 신경망 학습에 맞게 정규화하는 방법은 다양하다.
심층 신경망은 다양한 문제를 일반적으로 잘 풀 수 있다는 장점이 있으나,
적절한 정규화를 적용하면 성능과 학습 속도를 더 높일 수 있다.
심층 신경망 안의 노드들은 0을 중심으로 ±1 정도의 값을 가질 때 학습이 잘 된다.
따라서 정규화의 목표는 다양한 척도에 분포하는 값들을 0과 1 사이로 옮기는 것이다.

준공연도는 매 해의 간격이 일정한 등간 변수이며,
평면도가 갖춰진 최초 사례의 1969년에서
데이터 수집 시점에서 가장 최근인 2019년까지 51년의 범위에 걸쳐있다.
준공연도를 0에서 1 사이 범위로 옮기기 위해 1969년을 0, 2019년을 1로 정의하여
단순하게 선형적으로 정규화한다.

한국 아파트의 전용면적은 국민주택 규모 기준인 $85 m^2$와 $60 m^2$ 에 집중되어 있으며,
그 외 $85 m^2$ 이상 $135 m^2$ 미만 중대형에서는 전용면적이 다양하게 나타난다.

![전용면적 분포](area_kde.pdf)

전용면적은 비율 변수인데다 대형 평형으로 갈수록 면적이 빠르게 커지는 특성이 나타난다.
또한, 첨두 2개에 많은 사례가 집중되어 있어 단순한 정규화를 적용하는 것이 적절하지 않다.
최빈값인 $85 m^2$이 중심이 되도록 하고,
그 다음으로 유형이 많은 $60 m^2$이 1만큼 간격이 떨어지도록 하면서,
비율 변수의 특성을 살리면서도 평균이 0이 되도록 할 필요가 있다.
이를 위해 면적에 로그를 적용해 대형과 소형의 균형을 조절하고,
로그 함수의 밑을 $85 m^2$와 $60 m^2$의 비율 차이로 정의하여
두 평형의 간격을 1로 맞추는 로그 정규화를 적용한다.

정리하면 [@tbl:dataset]와 같다.

변수명|형식|정의
------|------|---------------
floorplan|3차원 배열|평면도 공간배치 (각 주거공간별)
plan_id|텍스트|평면유형 ID
sido|정수|시도별 권역 (@tbl:sido)
norm_year|실수|정규화한 준공연도: $\dfrac{year - 1969}{2019 - 1969}$ (1969년: 0, 2019년: 1)
norm_area|실수|로그 정규화한 전용면적: $\dfrac{\log (area / 85)}{\log (85/60)}$ (60 $m^2$: -1, 85 $m^2$: 0)
num_rooms|정수|침실 수
num_baths|정수|화장실 수

: 한국 아파트 공간배치 데이터셋 구성 {#tbl:dataset}

## 소결

한국 아파트의 단위세대 평면계획에 대한
심층 신경망 학습에 적용할 수 있는
한국 아파트 공간배치 데이터셋을 구축하였다.

한국 아파트 전수에 대하여 단위세대 평면도를 수집 및 분석하고,
단위세대 영역 및 LDK, 침실, 현관, 발코니, 화장실 등 실내 공간배치와
시기, 지역, 면적 등 연관 정보를
심층 신경망 학습에 적합한 방식으로 정리하였다.

이 과정을 통하여 한국 아파트에 대한 기계학습 연구의 가능성을 확인하였다.
이 데이터셋은 단위세대 평면계획에 대한 분석 및 평면 설계 자동화 등 다양한 연구의 바탕이 된다.

\newpage