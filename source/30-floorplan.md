# 한국 아파트 단위평면 데이터셋 {#sec:floorplan}

이 장에서는 한국 아파트 단위평면의 공간배치를 데이터셋으로 구축한다.
데이터셋 (dataset, 정보집합물)은 "구조화된 데이터 개체들의 식별 가능한 집합"을 말한다. [@ProjectOpenData2014]
개별 자료가 체계적으로 정리되어 그 전체가 하나로서 인식되는 모든 자료의 집합은 데이터셋이 될 수 있으나,
현재는 그중에서도 특히 전자적으로 저장 및 공유되어 컴퓨터를 이용한 분석에 활용될 수 있는 것을 지칭한다.

[@sec:dl]에서 살펴본 바와 같이,
한국 아파트 연구에 딥 러닝 분석을 적용하기 위해서는
한국 아파트 전체를 대표할 수 있는 데이터가 필수적이다.
공개된 정보를 활용하여 전국 아파트의 단위평면 및 관련 자료를 수집하고,
평면에서 나타나는 공간배치를 인식하는 알고리즘을 개발하고 적용한다.
인식된 공간배치와 관련 정보를 딥 러닝 모형에 입력할 수 있는 형식으로 정리하여 데이터셋으로 구축한다.

이러한 과정을 개별 평면에 대한 수작업 없이도 처리할 수 있도록 하여,
누구라도 같은 과정을 통해 연구의 결과를 재현할 수 있도록 한다.
이렇게 구축된 단위평면 데이터셋을 활용하여
한국 아파트 단위평면 공간에 대한 분석을 전수조사를 통해 수행할 수 있도록 한다.

## 단위평면 자료 수집

한국 아파트 전체를 대표할 수 있는 최대한 넓은 범위의 단위평면 자료를 얻기 위하여,
전국 아파트에 대한 정보를 공개적으로 제공하는 네이버 부동산에서
단위평면 및 관련 계획 정보를 수집한다.

네이버 부동산은 2017년 5월 24일 기준
전국 아파트 29,663 단지의 121,258 평면유형에 대한 정보를 제공하며,
51,497개 유형에 대한 평면도가 게시되어 있다. [@naverland]

![시도별 연도별 평면도 수록 건수 [@naverland]](floorplans_by_year_sido.png)

네이버 부동산에서 제공하는 아파트 평면도는 이미지 형식이다.
정해진 축척 없이 일정한 크기의 이미지 안에 단위세대 실내 공간배치를 표현한다.
대부분 주동의 실제 배치와 관계없이
거실과 주 침실이 외기에 면하는 주 향이 아래로 오게 정렬되지만,
좁고 깊은 형태의 단위세대 중 일부는
좌우로 더 긴 이미지 크기에 맞추어 90도 회전되어 그려진다.
계단실을 중심으로 반전된 공간배치를 보이는 계단실형 주동에서는
둘 모두를 같은 평면 유형으로 처리하고 한 가지 방향의 평면도만 제공한다.

평면에 표현되는 정보는 단위세대 실내 구조 및 공간배치를 중심으로
각 실의 이름, 가구 배치, 면적, 치수 등의 정보가 부가된다.
일부 평면에서는 공용 공간과 인접 세대가 함께 표현되기도 한다.
각 실의 성격에 따라 색으로 표현되는데,
현관은 흰색과 회색의 체크 무늬, LDK는 갈색 마루 무늬, 침실은 황갈색, 발코니는 연미색, 화장실은 하늘색으로 나타낸다.
기타 설비 공간, 수납 공간 등을 회색으로 표현하는 경우가 있고,
가구나 출입문 등은 색을 채우지 않는다.

![평면도 예시 [@naverland]](floorplan_samples.png){#fig:samples}

## 공간배치 인식

수집된 한국 아파트의 단위평면에서 나타나는 다양한 오류에 견고한(robust) 공간배치 인식 알고리즘을 개발한다.

### 단위평면 분석 전략

한국 아파트의 단위세대는 대부분 단층이지만 복층 단위세대도 일부 존재한다.
그러나 단위평면에 복층 공간을 표현하는 방식은 일관되게 나타나지 않는다.
공간배치 인식 알고리즘은 2차원 평면에 일관되게 표현되는 단층 단위세대를 대상으로 한다.

벽식 구조가 대부분인 한국 아파트에서 중요한 요소인 벽체는
단위평면에서 명확하게 나타나지만 정확하게 표현되지는 않는다.
대부분의 평면도에서 세대 경계를 단순히 모두 벽으로 표현하면서
개구부가 표현되지 않는다.
그러나 모든 단위평면에서 일관된 것은 아니고, 일부 평면은 개구부를 정확하게 나타내기도 한다.
문이나 막히지 않은 공간 경계가 벽으로 그려지는 오류도 종종 발생한다.
이를 주어진 정보대로 인식한다면 그 세대는 창이 없는 \`먹방'으로 보일 것이다.
그렇기 때문에 벽체에 의존하여 공간 구조를 인식하는 것은
높은 빈도로 오류를 발생시키게 된다.

각 실에 대한 정보는 실 이름의 형태로 제공되기도 한다.
그러나 실 구분 기준이나 실 이름은 평면도마다 달라진다.
현관이나, 드레스룸, 발코니, 다용도실 등 규모가 작은 부속실의 경우
어떤 평면에서는 이름이 제공되고 다른 평면에서는 제공되지 않기도 한다.
일부 평면에서는 실별 면적까지도 제공하지만, 대다수의 평면에서는 그렇지 않아
단위평면 인식에 도움이 되지 않는다.

<div id="fig:">

![정렬되지 않은 복층 평면도](fp_multifloor.jpg){height=60%}

![실 이름 오류 (오른쪽 침실 누락, 현관 및 주방/식당 오류)](fp_label_error.jpg){height=25%}
![벽체 및 출입문 오류 (오른쪽 위 침실)](fp_wall_error.jpg){height=25% #fig:wall_error}

단위평면 오류 예시 [@naverland]
</div>

사람은 도면에 다양한 오류가 있어도 어려움 없이 실제 내용을 파악할 수 있다.
그러나 컴퓨터는 주어진 입력을 있는 그대로 인식하기 때문에 현실과 동떨어진 결과를 내놓는다.
이렇게 컴퓨터가 도면을 인식하려고 할 때는 치명적인 오류가
도면을 작성하고, 검수하고, 공개 후에는 오류를 신고받아 수정하는
여러 절차를 거친 이후에도 남아있다는 것은
그러한 오류에도 불구하고 많은 사람이 평면도를 읽는 데 큰 지장이 없었다는 뜻이다.
발코니 창호가 벽체로 그려져 있더라도,
사람은 발코니가 무엇인지, 아파트가 대체로 어떻게 생겼는지를 선험적으로 알고 있으므로
깨닫지도 못하는 사이에 주어지지 않은 정보를 이용해 도면을 고쳐 인식한다.
마찬가지로, 문 없이 벽으로 막힌 방이 단위평면에 존재해도
사람은 작성자의 의도를 이해하고, 심지어 문이 있을 위치를 추측할 수도 있다.
이는 사람이 평면도를 읽고 공간배치를 인식하는 방식이
도면 정보를 있는 그대로 받아들이는 것과는 다르다는 의미이다.

이러한 오류가 모든 도면에 일관되게 유지된다면
알고리즘에 그러한 특성을 반영하여 교정할 수도 있다.
그러나 세대 경계의 벽체 표현처럼 의도적인 표현이 대다수 평면도에서 일치하는 경우에도
모든 평면이 통일되어 있지는 않으며
각 도면에는 의도적인 표현과 실수를 아울러 다양한 오류가 발생한다.
현실적으로 모든 도면이 오류 없이 그려져있다고 가정할 수 없기 때문에,
평면도에서 공간배치를 인식하려는 알고리즘도 이러한 한계를 반영한다.

반대로, 사람들이 가장 먼저 인식하고 고칠 필요를 느끼는 오류는
검증 과정에서 제일 쉽게 걸러질 것이므로,
모든 단위평면에서 가장 일관되게 오류 없이 표현되는 정보야말로
사람이 평면도를 인식하기 위해 가장 핵심적으로 의존하는 정보가 된다.
따라서 모든 평면도에서 공간배치를 인식할 수 있는 알고리즘을 개발하기 위하여
사람이 공간배치를 인식하고 재구성할 때 필요한 최소한의 정보만을 활용하여
공간배치를 인식하고 데이터셋으로 구축한다.

이미지 파일 형식으로 제공되는 평면도를 분석하고 처리하기 위하여
파이썬과 영상처리 라이브러리인 OpenCV를 활용한다. [@opencv_library]

### 단위세대 및 실 영역 인식 {#sec:recog}

평면도에서 각 실을 구분짓는 가장 중요한 정보는 벽과 개구부이지만
모든 평면도에서 개구부가 정확하게 표현되어 있지 않다는 점이 걸림돌이다. (@fig:wall_error)
도면 작성 과정에서 문을 빠뜨리면 벽으로 둘러싸인 어느 곳에도 연결되지 않은 방이 그려진다.
물론 현실에 존재하는 아파트에는 그런 일이 일어날 수 없고, 그 방은 어딘가로 연결되겠지만,
출입문이 빠진 평면도에서 추가적인 맥락 없이 정확한 위치를 재구성하는 것은 불가능하다.
따라서 개구부에 의존하지 않고 실내 영역을 인식할 필요가 있다.

수집된 단위평면에서
가장 명확하게 구분되고 오류 없이 제공되는 정보에 해당하는 것은
색으로 표현된 실 영역이다.
평면도는 단위세대 내부의 각 공간을 외부와 다른 색으로 채워 나타내고 있으며,
특히 현관, LDK (거실 및 주방, 식당), 침실, 발코니, 화장실은
각 실만의 색으로 일관되게 표현되고 있다.
따라서 공간배치 인식의 첫 단계는
색으로 표현된 공간 정보를 이용해 단위세대 내부 영역을 인식하는 것이다.

그러나 실내 영역의 색도 해당 영역을 정확하게 반영하고 있지는 않다.
각 실의 영역이 모두 실내 영역의 색으로 채워진 것이 아니기 때문이다.
가구, 출입문, 부속 실 등은 단위세대 실내에 속하지만 실내 영역의 색으로 표현되지 않는다.
따라서 색으로 제공되는 정보를 참고하여
실내 실 영역의 정확한 경계를 파악하고 전체 단위세대 영역을 인식하는 과정이 필요하다.

가장 먼저, 실외가 확실한 영역을 분리하여 제외한다.
흰 배경과, 단위세대와 분리되어 있는 치수 등을 제외하고,
실내 영역의 색에 연결되어 있는 영역을 단위세대 영역의 후보로 삼는다.

단위세대 실내와 연결되어 있더라도,
계단실 코어가 평면도에 같이 표현되어 있는 경우 그 부분은 실외로 분류한다.
벽과 현관, 발코니 등으로 공간을 나누었을 때
실내 영역의 색과 연결되지 않고 분리되는 큰 공간이 있다면
그 공간은 공용 공간으로 판단하고 실외가 명백한 영역에 포함한다.

<div id="fig:">

![평면도 원본 [@naverland]](fp_1.png){width=40%} \qquad
![실외가 확실한 평면 영역](fp_2.png){width=40%} \qquad

단위평면 실외 영역 인식
</div>

다음으로,
각 실의 경계 중에서 벽체를 제외한 실 경계 후보를 식별한다.
면적을 가지는 벽체는 쉽게 인식이 가능하며, 확실하게 각 실의 경계를 이룬다.
그러나 공간적으로 이어진 실 간의 경계를 인식하는 것은 단순하지 않은 문제이다.
각 실은 그 성격에 따라 색으로 구분되어 표현되지만, 그 실의 모든 공간이 같은 색으로 표현된 것은 아니다.
출입문이나 가구 등 다른 색으로 표현된 부분도 해당 실의 영역이므로, 그 영역이 인접한 실 중 어느 쪽에 속하는지를 판단할 필요가 있다.
따라서 벽체가 아닌 실 경계를 인식하는 과정이 필요하고,
이 단계에서는 그러한 경계가 될 수 있는 후보를 식별한다.
먼저,
실 경계를 표현하는 검은색 선을 인식한다.
평면도 이미지는 크기를 줄이기 위한 압축 과정에서 가느다란 선과 같은 형태는 왜곡될 수 있으므로,
선의 형태를 인식하는 것은 어렵다.
따라서 벽체를 제외한 검은색 영역을 검은색 선으로 인식한다.
이렇게 인식된 검은색 선 중에는
실제 선이 아닌 실 이름 및 치수 표기나,
검은색 실선이지만 실 경계가 아닌
출입문 및 가구 표기 등이 있다.
이 중에서 실제 실 경계가 될 수 있는 후보를 식별하기 위하여,
벽체로 구분된 실내 공간의 연결관계를 분석한다.
평면도의 형태학적 골격 (morphological skeleton)은
벽체를 제외한 공간의 형태에서 중심선만 남긴 것이다.
([@fig:skel])
형태학적 골격은 공간을 분절하는 실 경계를 식별하기에 적합한 도구이다.
실 경계를 식별하기 위한 전제는
실 경계는 두 실 사이를 연결하는 형태학적 골격과 교차하면서
동시에 벽체에 인접한다는 것이다.
이러한 조건을 만족하는 검은색 선만 선정하여
실 경계의 후보로 인식한다.
([@fig:border])
[@fig:zones]는 실 경계 후보로 구분된 개별 영역을 나타낸다.
출입문이나 가구 등
실 경계 후보 중에도 실제로 실 경계가 아닌 경우가 있기 때문에,
여러 영역이 하나의 실에 속할 수 있다.

<div id="fig:border">

![검은색 선 인식](fp_4.png){height=25%} \qquad
![실내 공간의 연결관계](fp_3.png){#fig:skel height=25%} \qquad
![실 경계 후보](fp_6.png){height=25%} \qquad

단위평면 실 경계 후보 인식
</div>

다음 단계에서는
각 실을 나타내는 색을 기준으로 실내가 확실한 영역을 찾고,
실내 공간을 파악하기 위한 핵으로 삼는다.
LDK (거실 및 주방, 식당), 침실, 발코니, 화장실은
각 실의 색이 다른 실의 색과 색상, 채도, 명도로 구분되므로,
해당 영역을 쉽게 분리할 수 있다.
현관은 배경과 부속 실 등에서 나타나는 것과 같은 흰색과 회색으로 표현되므로,
두 색의 체크 무늬를 인식하여 현관 영역을 분리한다.

명백히 실내인 영역과 실외인 영역을 제외하면
출입문, 가구, 부속 실 등 색이나 모양으로 실내외가 구분되지 않는 공간이 남는다.
예를 들어, 단위세대 바깥쪽으로 난 현관문이 그려진 영역은 실외이지만,
안쪽으로 열리는 침실 문은 침실 안에 그려진다.
흰색이나 회색으로 그려진 가구 및 부속 실도
어디에 위치하고 어떤 공간과 연결되느냐에 따라 해당 영역의 성격이 달라진다.

이러한 영역들은 실내외가 명백한 영역 중 가장 밀접하게 연결된 공간과 같은 영역으로 분류한다.
벽으로 막힌 부분을 제외하고,
실내외가 명백한 영역에 닿아있는 인접한 공간은
여러 영역 중 가장 넓게 맞닿아있는 영역과 같은 실로 분류한다.
해당 공간을 다시 실내외가 명백한 공간으로 분류하고,
그 공간에 맞닿은 또 다른 공간을 실내외로 분류하는 과정을
더 이상 새로운 공간이 실내외로 분류되지 않을 때까지 반복한다.

이러한 과정을 거친 후에도 평면도의 모든 부분이 실내와 실외로 구분된 것은 아니다.
예를 들어,
벽으로 둘러싸인 설비 공간은 어느 공간과도 맞닿지 않기 때문에
실내외 어느 쪽으로도 분류되지 않는다.
본 연구에서는 단위평면의 공간배치를 각 실 영역의 종합으로 정의하였기 때문에
실내에서 접근할 수는 없지만 단위세대 내부에 속하는 공간과
세대 외부는 똑같이 실내 어느 실 영역에도 속하지 않는 공간으로 취급된다.
그러나 실제로 거주자가 생활하는 공간의 배치를 분석한다는 점에서
단위세대의 각 실에서 접근이 가능한 실내 공간의 배치만 표현하여도
아파트의 공간 계획을 충분히 표현할 수 있다.

<div id="fig:">

![평면도 원본 [@naverland]](floorplan.jpg){height=25%}

![개별 영역 인식](fp_zones.png){height=25% #fig:zones}

![실내 영역 인식](fp_indoor.png){height=25%}

단위평면 실내 영역 인식
</div>

이러한 과정을 통하여,
단위평면 내부에 위치한
벽과 현관, LDK, 침실, 발코니, 화장실 영역을 인식하고,
인식된 공간배치 데이터를
2차원 이미지에서 각 영역을 2차원 행렬로 표현하여 쌓은
(이미지 폭\times 이미지 높이\times 6개 영역) 크기의 3차원 행렬의 형태로 처리한다.

### 평면도 축척 정규화

평면도 이미지는 같은 크기의 이미지 안에 단위평면을 최대한 크게 나타내기 위하여
정해진 축척 없이 그려져 있다.
공간배치를 비교하는 데 있어
공간의 크기도 중요한 정보이므로,
단위평면 데이터셋에서
모든 단위평면이 같은 축척으로 나타나도록 정규화한다.

평면도 이미지에는 치수가 표현되어 있을 때도 있지만
그렇지 않은 경우도 많다. (예: [@fig:wall_error])
따라서 치수가 제공되지 않는 평면도와 동일한 조건에서
모든 단위평면을 비교하려면
평면도에 표현된 치수에 의존하지 않는 방법이 필요하다.

[-@sec:recog]절에서 단위세대 실내 영역을 인식하였으므로,
그 크기를 별도로 제공되는 단위평면의 전용면적과 비교하여
평면도 이미지의 축척을 계산한다.
발코니 면적은 다양한 기준에 따라 전용면적에 산입되기도 하나,
대다수의 아파트에서는 발코니 면적이 전용면적에 포함되지 않도록 계획되었으므로,
발코니를 제외한 단위세대 실내 영역을 전용면적과 비교한다.

모든 평면도 이미지의 크기를 동일한 축척으로 조정한다.
평면도 이미지의 정확도를 고려하여
0.2미터 간격으로 공간배치를 표현하도록 정규화한다.

### 평면도 방향 정규화

모든 평면도를 같은 기준으로 비교하기 위하여,
유사한 평면도에서 모든 공간이 유사한 위치에 나타나도록
회전과 반전을 통하여 방향을 맞춘다.

이미 대다수의 평면도에서 단위평면은
거실과 침실이 발코니를 통하거나 직접 외기와 면하는 주 향이
아래쪽에 오도록 그려진다.
그러나 일부 평면도는
좁고 깊은 단위평면을 가로로 긴 이미지에 더 크게 표현하기 위하여
주 향이 왼쪽 또는 오른쪽으로 향하도록 90도 회전하여 그려져있다.
따라서 모든 단위평면에서 주 향이 아래쪽을 향하도록 회전시켜 정렬한다.

또한, 판상형 중 계단실형 주동과 탑상형 주동에서는
계단실 코어를 가운데 두고 거울상으로 계획된 두 평면이
같은 평면 유형으로 분류되어 같은 평면도를 공유한다.
복도형 단위세대에서도 설비 공간을 공유하기 위하여 반전된 평면이 계획되기도 한다.
따라서 대부분의 평면 유형에서 단위평면과 공용 공간의 방향도 통일할 필요가 있다.
공용공간이 실내 영역에서 나타나지는 않으므로,
공용 공간에서 이어지는 현관을 기준으로 삼는다.
주 향이 아래쪽으로 향한 상태에서,
현관이 단위세대의 왼쪽에 위치하도록 평면을 반전하여 맞춘다.

주 향의 판단은
이미지의 면적, 위치, 모양 등 형태적 특성을 수치화하는
이미지 모멘트 (image moments)를 활용한다.
단면 2차 모멘트가 구조 부재의 단면 형태가 가지는 휨 저항을 보여주는 것과 마찬가지로,
이미지 모멘트를 통해 이미지의 형태가 보이는 다양한 특성을 분석할 수 있다.

대부분의 평면도에서
주 향에 거의 반드시 발코니가 배치되는 점을 이용하여,
단위평면에 발코니가 있다면,
발코니가 단위평면에서 어느 쪽 끝에 많이 배치되었는지를
이미지 모멘트를 통하여 분석한다.

이를 위하여,
이미지의 크기, 회전, 변위에 상관없이 같은 값을 유지하는
정규화된 중심 모멘트 (normalized central moments) 중 2차 모멘트를 활용하여
발코니가 실내 전체에 비하여
상하로 치우친 경향이 좌우에 비해 더 큰지를 판단한다.
만약 발코니가 평면의 위아래 끝에 위치한다면
발코니의 상하 2차 모멘트는 실내 전체에 비하여 아주 크게 나타나고,
좌우 2차 모멘트는 실내 전체와 크게 다르지 않게 나타날 것이다.
이런 경우 주 향은 아래쪽에 있다고 판단하고 회전시키지 않는다.

만약 좌우 2차 모멘트의 차이가 더 크게 나타난다면,
발코니가 왼쪽과 오른쪽 중 한쪽으로 더 치우쳐 나타난다고 판단하고,
0차 모멘트와 1차 모멘트를 이용하여
발코니의 변위가 실내 전체에 비하여 좌우 어느 쪽에 위치하는지 보고
그 쪽을 주 향으로 판단한다.
그리고 다른 평면도와 마찬가지로 주 향이 아래쪽을 향하도록 평면도를 회전시킨다.

소수의 평면 유형에는 발코니가 계획되어있지 않기 때문에
이러한 알고리즘을 사용할 수 없다.
이 경우, LDK가 단위세대 전후면에 걸쳐 좁고 길게 나타난다는 점을 이용하여,
정규화된 중심 모멘트 중 2차 모멘트가
상하와 좌우 중 어느 쪽에서 더 큰가를 기준으로 평면의 방향을 판단한다.

주 향이 아래쪽에 오도록 회전된 평면에서
현관이 왼쪽에 오도록 반전시킨다.
현관이 좌우 중 어느 쪽에 위치하는지는
현관과 실내 전체 각각에 대하여
좌우 1차 모멘트를 0차 모멘트로 나눈 값을 비교하여 알 수 있다.
현관이 실내 전체에 비하여 오른쪽에 위치한다면
좌우 반전시켜 왼쪽으로 오도록 정렬한다.

이러한 과정을 통하여,
공간배치 데이터 속 단위평면의 주 향과 현관의 방향이
일관되게 나타나도록 정렬한다.

### 단위평면 공간배치 정렬

딥 러닝 모형은 입력값의 대부분이 의미있는 정보로 차 있어야 학습이 정상적으로 이루어진다.
따라서 다양한 크기의 단위평면을 같은 축척으로 표현한다면,
가장 큰 평면을 담아내기 위하여
대다수의 평면에서 면적의 대부분을 단위세대 외부로 남겨두기보다,
모든 평면에서 의미있게 달라지는 영역에 집중하는 것이 더 효율적이다.

서로 다른 크기의 단위평면을 일관되게 비교하기 위해서는
가장 의미 있는 부분이 같은 지점에 위치하도록
기준점을 설정하고 각 단위평면을 정렬할 필요가 있다.
본 연구에서는
주 향 경계의 중앙을 기준점으로 삼아,
입면에서부터 전개되는 실내 공간 계획을 비교한다.

많은 이미지 인식 딥 러닝 모형들에서
입력값으로 가로 및 세로가 224픽셀인 이미지를 입력값으로 갖는다.
CNN 모형에서는 각 계층에서 이미지 크기를 절반으로 줄이는 경우가 많으므로,
입력값의 크기도 기존 모형의 2배/절반 단위로 결정하는 것이 바람직하다.

224픽셀을 0.2미터/픽셀 축척을 적용하여 환산하면 44.8미터가 된다.
전용면적으로 정규화된 단위평면은
폭과 깊이 모두에서 약 12미터를 중심으로 분포한다. (@fig:fp_size)
224픽셀을 절반으로 줄인 112픽셀은 22.4미터가 되어
모든 평면을 손실 없이 담아낼 수 있다.
이러한 점을 고려하여
한국 아파트
단위평면 데이터셋에서 공간배치 데이터는 (112\times 112\times 6) 크기의 행렬로 표현한다.
단위평면보다 큰 공간배치 행렬 안에서
단위평면은
주 향이 위치한 하단이 행렬의 아래쪽 끝에 닿도록 상하로 정렬하고,
중앙은 가운데로 오도록 좌우로 정렬한다.

![단위평면의 폭 및 깊이 분포](fp_size_kde.pdf){#fig:fp_size}

이렇게 정렬하였을 때,
공간배치 행렬의 아래쪽 중앙부는 모든 단위평면에서 항상 실내공간이 된다.
이를 기준으로 공간배치 행렬의 주변부를 잘라내면
딥 러닝 모형의 학습에 필요한 대부분이 실내 공간인 입력 데이터를 얻을 수 있다.
공간배치 행렬의 크기를 가로 세로 절반으로 줄인 56픽셀은 11.2미터로
대부분의 평면에서 실내 영역에 해당하는 부분에 집중하여 분석할 수 있다.

이와 같이 처리된 단위평면 공간배치 인식 최종 결과물은 [@fig:recog]와 같다.

<div id="fig:recog">

![평면도 원본 [@naverland]](fp_before.png){height=40%}

![공간배치 인식](fp_after.png){height=40%}

단위평면 공간배치 인식
</div>

## 단위평면 데이터셋 구축

공간배치 인식 알고리즘을 단위평면에 적용하여 얻은
공간배치 데이터에 더하여
한국 아파트의 진화과정을 분석하는 데 함께 필요한
준공연도, 전용면적, 지역 등
아파트 계획 관련 정보를
기계학습에 적합한 형태로 변환하고
단위평면과 계획 관련 정보를 정리한
공간배치 데이터셋을 구축한다.

딥 러닝에서 사용하는 신경망 모형은
각 계층에서 출력된 값을 정규화 (normalization) 하는 과정을 거친다.
이러한 구조 때문에
입력값이 0을 중심으로 ±1 정도의 편차를 가질 때
가장 자연스럽게 학습이 가능하다.
따라서 준공연도와 전용면적 등과 같은 연속형 변수를
딥 러닝을 활용하여 학습시키기 위하여
그 값의 범위가 -1과 1 사이에 위치하도록 할 필요가 있다.

준공연도는 매 해의 간격이 일정한 등간 변수이며,
평면도가 갖춰진 최초 사례의 1969년에서
데이터 수집 시점에서 가장 최근인 2019년까지 51년의 범위에 걸쳐있다.
준공연도의 정규화는 단순하게 0에서 1 사이 범위로 옮긴다.
준공연도가 1969년이면 0, 2019년이면 1로 정의하고 그 사이의 값은 선형적으로 정규화한다.

전용면적은 절대영점이 있는 비율 변수이다.
한국 아파트의 전용면적은 국민주택 규모 기준인 85 제곱미터와 60 제곱미터에 집중되어 있으나,
85 제곱미터 이상 대형 평면에서는 매우 넓은 범위의 전용면적이 나타난다. ([@fig:area])
따라서
대형 평면의 극값을 기준으로 전용면적을 선형적으로 정규화하면
대부분의 평면이 해당하는 국민주택 규모에서는 거의 편차가 나타나지 않게 된다.

![전용면적 분포](area_kde.pdf){#fig:area}

이러한 문제를 해결하기 위하여,
전용면적에 로그를 취하여 비율 변수를 등간 변수로 변환하는
로그 정규화를 적용한다.
최빈값인 85 제곱미터가 중심값인 0이 되고,
그 다음으로 많은 60 제곱미터가 0에서 1만큼 떨어진 값을 갖도록
로그 함수의 밑을 $85 m^2$와 $60 m^2$의 비율 차이로 정의한다.
이 때 60 제곱미터는 -1로 변환되고, 약 120 제곱미터가 1의 값을 갖게 된다.
이렇게 하면 거의 모든 사례가 0 또는 0에서 1만큼 떨어진 값을 갖게 되어
딥 러닝에서 요구하는 입력값의 조건에 부합한다.

마지막으로, 평면 유형 사례가 속한 아파트가 위치한 지역을 범주형 변수로 처리한다.
아파트 계획의 지역별 차이를 분석하기 위하여
단위평면과 함께 해당 사례가 위치한 지역에 대한 정보가 필요하다.
기계학습으로 범주형 변수를 학습하기 위해서는
각 범주에 충분한 수의 사례가 균형을 이룰 필요가 있다.
그러나 아파트는 수도권에 집중되어 있어
시도나 시군구 등 같은 수준으로 분류한다면
사례가 적은 지방에 대한 학습이 이루어질 수 없다.
반대로 모든 범주가 비슷한 규모가 되도록 묶는다면
서울과 경기, 기타 지방으로 3등분하게 되어,
지역별 특색에 따른 차이가 사라지게 된다.

각 지역의 특색을 살리면서도 사례 수를 균형 있게 배분하기 위하여
평면 유형의 수와 지역의 관계를 고려하면서
인접한 시도를 묶어 9개 권역을 설정하였다. (@tbl:sido)
충청도, 전라도는 시례가 적어 하나의 권역으로 설정하였고,
경상도는 남북으로 나누어 광역시와 묶어 2개의 권역으로 설정하였다.
강원도와 제주도는 평면도가 있는 평면 유형 사례가 매우 적었지만,
지역 특성을 고려하여 다른 시도와 같은 권역으로 묶지 않았다.
이러한 권역 설정을 통하여
평면유형 분포의 불균형을 완화하면서 지역별 차이를 학습할 수 있도록 하였다.

|권역코드|해당 지역|평면유형 수|
|:---:|-------------------------------|---------:|
|0|서울|15,125|
|1|경기|14,444|
|2|인천|3,288|
|3|강원|1,107|
|4|대전, 세종, 충남, 충북|4,226|
|5|부산, 울산, 경남|6,866|
|6|대구, 경북|3,242|
|7|광주, 전남, 전북|2,075|
|8|제주|167|

: 시도별 권역 정의 {#tbl:sido}

단위평면의 공간배치 정보와 아파트의 계획 관련 정보를 포함하여
한국 아파트 단위평면 데이터셋의 구성을 정리하면 [@tbl:dataset]와 같다.

변수명|형식|정의
------|------|---------------
floorplan|3차원 배열|단위평면 공간배치
plan_id|텍스트|평면유형 ID
sido|정수|시도별 권역 (@tbl:sido)
norm_year|실수|정규화한 준공연도: $\dfrac{year - 1969}{2019 - 1969}$ (1969년: 0, 2019년: 1)
norm_area|실수|로그 정규화한 전용면적: $\dfrac{\log (area / 85)}{\log (85/60)}$ (60 $m^2$: -1, 85 $m^2$: 0)
num_rooms|정수|침실 수
num_baths|정수|화장실 수

: 한국 아파트 공간배치 데이터셋 구성 {#tbl:dataset}

## 소결

한국 아파트의 단위세대 평면계획에 대한
딥 러닝 기계학습에 활용할 수 있는
한국 아파트 공간배치 데이터셋을 구축하였다.

공개된 평면도를 활용하여 전국 아파트에 대한 전수조사를 가능하게 하였다.
평면도에서 공간배치를 인식하는 알고리즘을 개발하고,
이를 적용하여 축척과 방향이 통일된 공간배치를 비교할 수 있도록 하였다.
단위평면과 함께 필요한 계획 관련 정보를 딥 러닝으로 분석할 수 있도록 하였다.

\newpage
